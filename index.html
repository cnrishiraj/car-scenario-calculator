<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Scenario Calculator (OTD + EMI Matrix)</title>
  <style>
    :root { --bg:#0b1220; --card:#121b2f; --muted:#9fb0d0; --text:#e9efff; --ok:#5eea92; --bad:#fb7185; --warn:#fbbf24; --line:#223055; --blue:#2563eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 16px; border-bottom: 1px solid var(--line); }
    header h1 { margin:0; font-size: 18px; }
    header p { margin:6px 0 0; color: var(--muted); font-size: 13px; line-height:1.35; }
    main { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: 1.05fr 0.95fr; gap: 12px; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 15px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 560px){ .row { grid-template-columns: 1fr; } }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, button, textarea {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0e1730;
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 70px; resize: vertical; }
    input:focus, textarea:focus, select:focus { border-color: #3b82f6; }
    .btns { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    button { cursor: pointer; font-weight: 700; }
    button.primary { background: var(--blue); border-color: var(--blue); }
    button.ghost { background: transparent; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }
    .pill {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #0e1730;
    }
    .pill .k { font-size: 12px; color: var(--muted); }
    .pill .v { font-size: 18px; font-weight: 800; margin-top: 4px; }
    .status { margin-top: 10px; padding: 10px; border-radius: 12px; border: 1px solid var(--line); background:#0e1730; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 12px; overflow: hidden; }
    th, td { border-bottom: 1px solid var(--line); padding: 9px 10px; font-size: 12.5px; text-align: left; vertical-align: top; }
    th { color: var(--muted); font-weight: 800; background: rgba(255,255,255,0.02); }
    tr:hover td { background: rgba(59,130,246,0.08); }
    .small { font-size: 12px; color: var(--muted); }
    .tag { display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:11px; color:var(--muted); margin-left:6px; }
    .goodCell { color: var(--ok); font-weight: 800; }
    .badCell { color: var(--bad); font-weight: 800; }
    .warnCell { color: var(--warn); font-weight: 800; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tableWrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 12px; }
    .matrixCell { cursor: pointer; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .chip { border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); background:#0e1730; }
    .chip b { color: var(--text); }
    @media (max-width: 560px){
      header { padding: 12px; }
      main { padding: 12px; }
      th, td { padding: 12px 8px; }
      .btns { position: sticky; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, rgba(11,18,32,0) 0%, rgba(11,18,32,0.9) 30%, rgba(11,18,32,1) 100%); padding-bottom: 8px; z-index: 5; }
    }
  </style>
</head>
<body>
<header>
  <h1>Car Scenario Calculator</h1>
  <p>
    Enter dealer numbers (price, fees, tax), then run a matrix across <b>Down Payments × APRs × Terms</b>.
    Each cell shows <b>EMI / All-in</b>. Click a cell to select a scenario and see totals + negotiation target.
  </p>
</header>

<main class="grid">
  <!-- Inputs -->
  <section class="card">
    <h2>Deal Inputs</h2>

    <div class="row">
      <div>
        <label>Car name (optional)</label>
        <input id="carName" placeholder="e.g., 2021 GLC 300 4MATIC / 2020 XC40" />
      </div>
      <div>
        <label>VIN (optional)</label>
        <input id="vin" placeholder="VIN (optional)" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Vehicle price (advertised / negotiated) ($)</label>
        <input id="price" type="number" step="0.01" inputmode="decimal" value="27618" />
      </div>
      <div>
        <label>Sales tax rate (%)</label>
        <input id="taxRate" type="number" step="0.01" inputmode="decimal" value="3" />
      </div>
    </div>

    <h2 style="margin-top:16px;">Fees (dealer can edit)</h2>
    <div class="row">
      <div>
        <label>Doc / Admin fee ($) <span class="tag">taxable</span></label>
        <input id="docFee" type="number" step="0.01" inputmode="decimal" value="799" />
      </div>
      <div>
        <label>Registration/Title/DMV ($) <span class="tag">non-taxable</span></label>
        <input id="regFee" type="number" step="0.01" inputmode="decimal" value="200" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Other taxable fees ($) <span class="tag">taxable</span></label>
        <input id="otherTaxable" type="number" step="0.01" inputmode="decimal" value="0" />
      </div>
      <div>
        <label>Other non-taxable fees ($) <span class="tag">non-taxable</span></label>
        <input id="otherNonTaxable" type="number" step="0.01" inputmode="decimal" value="0" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Estimated insurance / month ($)</label>
        <input id="ins" type="number" step="0.01" inputmode="decimal" value="150" />
      </div>
      <div>
        <label>Max all-in monthly budget (EMI + insurance) ($)</label>
        <input id="maxAllIn" type="number" step="0.01" inputmode="decimal" value="500" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Target car-only EMI ($)</label>
        <input id="targetEmi" type="number" step="0.01" inputmode="decimal" value="300" />
      </div>
      <div>
        <label>Max car-only EMI (screening) ($)</label>
        <input id="maxEmi" type="number" step="0.01" inputmode="decimal" value="350" />
      </div>
    </div>

    <h2 style="margin-top:16px;">Scenario Inputs (comma-separated)</h2>
    <div class="row">
      <div>
        <label>Down payments ($) — e.g., 5000,7000,10000</label>
        <input id="downs" value="5000,7000,10000" />
      </div>
      <div>
        <label>Loan terms (months) — e.g., 48,60,72</label>
        <input id="terms" value="48,60,72" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>APRs (%) — e.g., 4.5,5.5,6.5,9.5</label>
      <input id="aprs" value="4.5,5.5,6.5,8.5" />
    </div>

    <div class="btns">
      <button class="primary" id="calcBtn">Run scenarios</button>
      <button class="ghost" id="copyBtn">Copy summary</button>
    </div>

    <div class="hint">
      Tax model: tax is applied to <b>(vehicle price + doc fee + other taxable fees)</b>. Registration/DMV and other non-taxable fees are added after tax.
      If your dealer taxes doc fee differently, move it to “non-taxable fees”.
    </div>
  </section>

  <!-- Results -->
  <section class="card">
    <h2>Quick summary</h2>

    <div class="row">
      <div class="pill">
        <div class="k">Estimated OTD (out-the-door)</div>
        <div class="v" id="otd">$0</div>
        <div class="small" id="otdBreakdown"></div>
      </div>
      <div class="pill">
        <div class="k">Taxable subtotal (price + taxable fees)</div>
        <div class="v" id="taxableSubtotal">$0</div>
        <div class="small" id="taxLine"></div>
      </div>
    </div>

    <div class="legend">
      <div class="chip"><b>Green</b> = within Max EMI & Max all-in</div>
      <div class="chip"><b>Yellow</b> = EMI OK but all-in too high (insurance pushes it)</div>
      <div class="chip"><b>Red</b> = all-in too high</div>
    </div>

    <div id="statusBox" class="status small" role="status" aria-live="polite"></div>

    <h2 style="margin-top:16px;">Scenario matrix (Down × APR × Term)</h2>
    <div class="small">
      Each cell shows: <span class="mono">EMI / All-in</span> (All-in = EMI + insurance). Click any cell to select that scenario.
    </div>
    <div class="tableWrap">
      <table>
        <thead id="matrixHead"></thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>

    <h2 style="margin-top:16px;">Selected scenario (what the totals below use)</h2>
    <div class="row">
      <div class="pill">
        <div class="k">Selected scenario</div>
        <div class="v" id="selScenario">—</div>
        <div class="small" id="selLoan">—</div>
      </div>
      <div class="pill">
        <div class="k">To hit target EMI, required price cut</div>
        <div class="v" id="selCut">$0</div>
        <div class="small" id="selCutNote">—</div>
      </div>
    </div>

    <h2 style="margin-top:16px;">Totals by APR × Term (loan-only)</h2>
    <div class="small">
      Cells show: <span class="mono">Loan Total Paid / Interest / Cash Out</span>
      where <b>Cash Out = Down Payment + Loan Total Paid</b>. Totals exclude insurance.
    </div>
    <div class="small" id="totalsNote"></div>
    <div class="tableWrap">
      <table>
        <thead id="totalsHead"></thead>
        <tbody id="totalsBody"></tbody>
      </table>
    </div>

    <h2 style="margin-top:16px;">Top fits (closest to target)</h2>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Down</th>
            <th>APR</th>
            <th>Term</th>
            <th>EMI</th>
            <th>All-in</th>
            <th>Needed price cut to hit target</th>
          </tr>
        </thead>
        <tbody id="topFits"></tbody>
      </table>
    </div>

    <textarea id="summaryText" class="mono" style="margin-top:12px;" readonly></textarea>
    <div class="hint">“Copy summary” copies the text so you can paste it to WhatsApp/Email while negotiating.</div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  // Global selection state so totals + details are always consistent
  let SELECTED = null;

  function money(n) {
    if (!isFinite(n)) return "$0";
    return n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
  }
  function money2(n) {
    if (!isFinite(n)) return "$0.00";
    return n.toLocaleString(undefined, { style: "currency", currency: "USD", minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function num(id) {
    const v = parseFloat($(id).value);
    return isFinite(v) ? v : 0;
  }
  function parseList(str, kind) {
    return (str || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .map(s => (kind === "int" ? parseInt(s, 10) : parseFloat(s)))
      .filter(v => isFinite(v) && v >= 0);
  }

  // Standard amortization monthly payment
  function monthlyPayment(principal, aprPct, months) {
    const r = (aprPct / 100) / 12;
    if (months <= 0) return 0;
    if (principal <= 0) return 0;
    if (r === 0) return principal / months;
    return principal * (r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1);
  }

  // Tax model: tax applies to (price + taxable fees). Non-taxable fees added after.
  function computeOTD(price, taxRatePct, docFee, otherTaxable, regFee, otherNonTaxable) {
    const taxableSubtotal = price + docFee + otherTaxable;
    const tax = taxableSubtotal * (taxRatePct / 100);
    const otd = taxableSubtotal + tax + regFee + otherNonTaxable;
    return { otd, taxableSubtotal, tax };
  }

  // Given target EMI, compute max loan principal for apr/term
  function maxLoanForPayment(targetEmi, aprPct, months) {
    let lo = 0, hi = 250000;
    for (let i = 0; i < 70; i++) {
      const mid = (lo + hi) / 2;
      const pmt = monthlyPayment(mid, aprPct, months);
      if (pmt > targetEmi) hi = mid;
      else lo = mid;
    }
    return lo;
  }

  // Back solve max vehicle price to hit target EMI for scenario
  function maxVehiclePriceForTarget(targetEmi, aprPct, months, down, taxRatePct, docFee, otherTaxable, regFee, otherNonTaxable) {
    const maxLoan = maxLoanForPayment(targetEmi, aprPct, months);
    const maxOtd = maxLoan + down;
    const taxMult = 1 + (taxRatePct / 100);
    const maxPrice = ((maxOtd - regFee - otherNonTaxable) / taxMult) - docFee - otherTaxable;
    return { maxLoan, maxOtd, maxPrice };
  }

  function cellClass(emi, maxEmi, allIn, maxAllIn) {
    const okEmi = emi <= maxEmi;
    const okAll = allIn <= maxAllIn;
    if (okEmi && okAll) return "goodCell";
    if (!okAll) return "badCell";
    return "warnCell";
  }

  function renderSelected(price, targetEmi, taxRate, docFee, otherTaxable, regFee, otherNonTaxable) {
    if (!SELECTED) return;

    $("selScenario").textContent = `${money(SELECTED.down)} down @ ${SELECTED.apr.toFixed(2)}% for ${SELECTED.term} months`;
    $("selLoan").textContent =
      `OTD ≈ ${money(SELECTED.otd)} | Financed principal (OTD − down) ≈ ${money(SELECTED.principal)} | EMI ≈ ${money(SELECTED.emi)} | All-in ≈ ${money(SELECTED.allIn)}`;

    $("selCut").textContent = money(SELECTED.neededCut);
    $("selCutNote").textContent =
      SELECTED.neededCut > 0
        ? `To hit target EMI ${money(targetEmi)} for THIS selected scenario, vehicle price must be ~${money(SELECTED.maxPrice)} (before fees/tax inputs).`
        : `This selected scenario already supports target EMI at the current price & fees.`;

    renderTotals(
      parseList($("aprs").value, "float"),
      parseList($("terms").value, "int"),
      SELECTED.down,
      SELECTED.otd
    );
  }

  // Totals table: based on selected DOWN, with principal = OTD - down
  function renderTotals(aprs, terms, down, otd) {
    const head = $("totalsHead");
    const body = $("totalsBody");
    const note = $("totalsNote");
    head.innerHTML = "";
    body.innerHTML = "";

    const principal = Math.max(0, otd - down);

    // Round to cents (more realistic)
    const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;

    const hr = document.createElement("tr");
    hr.innerHTML = `<th>Term</th>` + aprs.map(a => `<th>APR ${a.toFixed(2)}%<br/><span class="small">Paid / Interest / CashOut</span></th>`).join("");
    head.appendChild(hr);

    note.textContent =
      `Totals are calculated for the SELECTED down payment ${money(down)}. ` +
      `Financed principal = OTD ${money(otd)} − down ${money(down)} = ${money(principal)}. ` +
      `Totals exclude insurance. “CashOut” includes down + loan payments.`;

    for (const term of terms) {
      const tr = document.createElement("tr");
      let cells = "";

      for (const apr of aprs) {
        const emiRaw = monthlyPayment(principal, apr, term);
        const emi = round2(emiRaw);

        const totalPaid = round2(emi * term); // loan-only paid
        const totalInterest = round2(Math.max(0, totalPaid - principal));
        const cashOut = round2(down + totalPaid);

        cells += `<td class="mono">${money2(totalPaid)}<span class="small"> / ${money2(totalInterest)} / ${money2(cashOut)}</span></td>`;
      }

      tr.innerHTML = `<td class="mono">${term} mo</td>` + cells;
      body.appendChild(tr);
    }
  }

  function run() {
    const carName = $("carName").value.trim();
    const vin = $("vin").value.trim();

    const price = num("price");
    const taxRate = num("taxRate");
    const docFee = num("docFee");
    const regFee = num("regFee");
    const otherTaxable = num("otherTaxable");
    const otherNonTaxable = num("otherNonTaxable");

    const ins = num("ins");
    const maxAllIn = num("maxAllIn");
    const targetEmi = num("targetEmi");
    const maxEmi = num("maxEmi");

    const downs = parseList($("downs").value, "float");
    const terms = parseList($("terms").value, "int");
    const aprs = parseList($("aprs").value, "float");

    if (!downs.length || !terms.length || !aprs.length) {
      $("statusBox").textContent = "Please provide comma-separated lists for downs, terms, and APRs (e.g., 5000,7000,10000).";
      return;
    }

    const { otd, taxableSubtotal, tax } = computeOTD(price, taxRate, docFee, otherTaxable, regFee, otherNonTaxable);

    $("otd").textContent = money(otd);
    $("taxableSubtotal").textContent = money(taxableSubtotal);
    $("taxLine").textContent = `Tax @ ${taxRate.toFixed(2)}% ≈ ${money2(tax)}`;
    $("otdBreakdown").textContent =
      `OTD = (Price + taxable fees) ${money(taxableSubtotal)} + tax ${money2(tax)} + non-taxable fees ${money(regFee + otherNonTaxable)}`;

    $("statusBox").innerHTML =
      `<div><b>OTD breakdown</b>: taxable subtotal = price ${money(price)} + doc ${money(docFee)} + other taxable ${money(otherTaxable)}.</div>
       <div><b>Financed principal in any scenario</b> = OTD − down payment.</div>
       <div>Click a matrix cell to select a scenario. The Totals table below will ALWAYS use the selected scenario’s down payment.</div>`;

    // Matrix headers
    const head = $("matrixHead");
    head.innerHTML = "";
    const hr1 = document.createElement("tr");
    hr1.innerHTML =
      `<th rowspan="2">Down</th><th rowspan="2">Financed<br/><span class="small">(OTD − down)</span></th>` +
      aprs.map(apr => `<th colspan="${terms.length}">APR ${apr.toFixed(2)}%</th>`).join("");
    head.appendChild(hr1);

    const hr2 = document.createElement("tr");
    hr2.innerHTML = aprs.map(() => terms.map(t => `<th>${t} mo</th>`).join("")).join("");
    head.appendChild(hr2);

    const body = $("matrixBody");
    body.innerHTML = "";

    const allScenarioRows = [];

    for (const down of downs) {
      const principal = Math.max(0, otd - down);
      const tr = document.createElement("tr");

      const leftCells = `
        <td class="mono">${money(down)}</td>
        <td class="mono">${money(principal)}</td>
      `;

      let cells = "";
      for (const apr of aprs) {
        for (const term of terms) {
          const emi = monthlyPayment(principal, apr, term);
          const allIn = emi + ins;

          const cls = cellClass(emi, maxEmi, allIn, maxAllIn);

          // Needed cut to hit target EMI
          const back = maxVehiclePriceForTarget(targetEmi, apr, term, down, taxRate, docFee, otherTaxable, regFee, otherNonTaxable);
          const neededCut = Math.max(0, price - back.maxPrice);

          cells += `<td class="${cls} mono matrixCell" data-down="${down}" data-apr="${apr}" data-term="${term}">
                    ${money(emi)}<span class="small"> / ${money(allIn)}</span>
                  </td>`;

          allScenarioRows.push({
            down, apr, term,
            emi, allIn,
            neededCut,
            maxPrice: back.maxPrice,
            principal,
            otd
          });
        }
      }

      tr.innerHTML = leftCells + cells;
      body.appendChild(tr);
    }

    // Default selected: prioritize within constraints, then closest to target
    if (allScenarioRows.length) {
      const ranked = allScenarioRows.slice().sort((a, b) => {
        const aOk = (a.emi <= maxEmi) && (a.allIn <= maxAllIn);
        const bOk = (b.emi <= maxEmi) && (b.allIn <= maxAllIn);
        if (aOk !== bOk) return aOk ? -1 : 1;
        const da = Math.abs(a.emi - targetEmi);
        const db = Math.abs(b.emi - targetEmi);
        if (da !== db) return da - db;
        return a.neededCut - b.neededCut;
      });

      const best = ranked[0];
      SELECTED = {
        down: best.down,
        apr: best.apr,
        term: best.term,
        emi: best.emi,
        allIn: best.allIn,
        neededCut: best.neededCut,
        maxPrice: best.maxPrice,
        principal: best.principal,
        otd: best.otd
      };
    }

    // Click to select scenario
    [...body.querySelectorAll("td[data-down]")].forEach(td => {
      td.addEventListener("click", () => {
        const down = parseFloat(td.getAttribute("data-down"));
        const apr = parseFloat(td.getAttribute("data-apr"));
        const term = parseInt(td.getAttribute("data-term"), 10);

        const principal = Math.max(0, otd - down);
        const emi = monthlyPayment(principal, apr, term);
        const allIn = emi + ins;

        const back = maxVehiclePriceForTarget(targetEmi, apr, term, down, taxRate, docFee, otherTaxable, regFee, otherNonTaxable);
        const neededCut = Math.max(0, price - back.maxPrice);

        SELECTED = { down, apr, term, emi, allIn, neededCut, maxPrice: back.maxPrice, principal, otd };
        renderSelected(price, targetEmi, taxRate, docFee, otherTaxable, regFee, otherNonTaxable);
      });
    });

    // Render selected + totals
    renderSelected(price, targetEmi, taxRate, docFee, otherTaxable, regFee, otherNonTaxable);

    // Top fits
    const top = allScenarioRows.slice().sort((a, b) => {
      const aOk = (a.emi <= maxEmi) && (a.allIn <= maxAllIn);
      const bOk = (b.emi <= maxEmi) && (b.allIn <= maxAllIn);
      if (aOk !== bOk) return aOk ? -1 : 1;
      const da = Math.abs(a.emi - targetEmi);
      const db = Math.abs(b.emi - targetEmi);
      if (da !== db) return da - db;
      return a.neededCut - b.neededCut;
    }).slice(0, 8);

    const topFits = $("topFits");
    topFits.innerHTML = "";
    for (const r of top) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${money(r.down)}</td>
        <td class="mono">${r.apr.toFixed(2)}%</td>
        <td class="mono">${r.term}</td>
        <td class="mono">${money(r.emi)}</td>
        <td class="mono">${money(r.allIn)}</td>
        <td class="mono">${money(r.neededCut)} <span class="small">(max price ~${money(r.maxPrice)})</span></td>
      `;
      topFits.appendChild(tr);
    }

    // Summary text
    const summary =
`Car: ${carName || "(not set)"} ${vin ? " | VIN: " + vin : ""}
Inputs:
- Price: ${money(price)}
- Tax: ${taxRate.toFixed(2)}%
- Doc fee (taxable): ${money(docFee)}
- Other taxable: ${money(otherTaxable)}
- Reg/DMV (non-taxable): ${money(regFee)}
- Other non-taxable: ${money(otherNonTaxable)}
- Est. OTD: ${money(otd)}
Budget:
- Target EMI: ${money(targetEmi)} | Max EMI: ${money(maxEmi)}
- Insurance/mo: ${money(ins)} | Max all-in: ${money(maxAllIn)}

Selected scenario (Totals table uses THIS down payment):
- Down ${money(SELECTED?.down ?? 0)} | APR ${(SELECTED?.apr ?? 0).toFixed(2)}% | Term ${SELECTED?.term ?? 0} mo
- Principal (OTD - down): ${money(SELECTED?.principal ?? 0)} | EMI: ${money(SELECTED?.emi ?? 0)} | All-in: ${money(SELECTED?.allIn ?? 0)}

Top fits (Down / APR / Term => EMI / All-in | Needed price cut):
${top.map(r => `- ${money(r.down)} / ${r.apr.toFixed(2)}% / ${r.term}mo => ${money(r.emi)} / ${money(r.allIn)} | cut ${money(r.neededCut)} (max price ~${money(r.maxPrice)})`).join("\n")}
`;
    $("summaryText").value = summary;
  }

  async function copySummary() {
    const text = $("summaryText").value;
    try {
      await navigator.clipboard.writeText(text);
      $("copyBtn").textContent = "Copied";
      setTimeout(() => $("copyBtn").textContent = "Copy summary", 1000);
    } catch {
      $("summaryText").focus();
      $("summaryText").select();
      document.execCommand("copy");
    }
  }

  $("calcBtn").addEventListener("click", run);
  $("copyBtn").addEventListener("click", copySummary);

  run();
</script>
</body>
</html>
